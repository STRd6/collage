<!DOCTYPE html>

<html>
<head>
  <title>lib/touchscreen</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="https://strd6.github.io/cdn/parallel/docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    <ul class="sections">
      <li id="section-1">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-1">&#182;</a>
    </div>
    <h1 id="touch-screen">Touch Screen</h1>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
</li>
<li id="section-2">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-2">&#182;</a>
    </div>
    <p>A screen you can TOUCH!</p>
<h2 id="implementation">Implementation</h2>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
</li>
<li id="section-3">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-3">&#182;</a>
    </div>
    <p>An element that reports mouse and touch events. The events
are scaled to the size of the element with [0, 0] being in the top
left and a number close to 1 being in the bottom right.</p>
<p>We track movement outside of the element so the positions are not
clamped and return their true value if the element were to extend.
This means that it is possible to receive negative numbers and
numbers &gt;= 1 for positions.</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">Bindable = require <span class="string">"bindable"</span>

module.<span class="function"><span class="title">exports</span></span> = (element) -&gt;
  self = Bindable()

  element ?= document.createElement <span class="string">"div"</span>
  self.<span class="function"><span class="title">element</span></span> = -&gt;
    element

  <span class="comment"># Keep track of if the mouse is active in the element</span>
  active = <span class="literal">false</span></code></pre>
</div>
</li>
<li id="section-4">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-4">&#182;</a>
    </div>
    <p>When we click within the element set the value for the position we clicked at.</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">  listen element, <span class="string">"mousedown"</span>, (e) -&gt;
    active = <span class="literal">true</span>

    self.trigger <span class="string">"touch"</span>, localPosition(e)</code></pre>
</div>
</li>
<li id="section-5">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-5">&#182;</a>
    </div>
    <p>Handle touch starts</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">  listen element, <span class="string">"touchstart"</span>, (e) -&gt;
    <span class="comment"># Global `event`</span>
    processTouches event, (touch) -&gt;
      self.trigger <span class="string">"touch"</span>, localPosition(touch)</code></pre>
</div>
</li>
<li id="section-6">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-6">&#182;</a>
    </div>
    <p>When the mouse moves trigger an event with the current position.</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">  listen element, <span class="string">"mousemove"</span>, (e) -&gt;
    <span class="keyword">if</span> active
      self.trigger <span class="string">"move"</span>, localPosition(e)</code></pre>
</div>
</li>
<li id="section-7">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-7">&#182;</a>
    </div>
    <p>Handle moves outside of the element if the action was initiated within the element.</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">  listen document, <span class="string">"mousemove"</span>, (e) -&gt;
    <span class="keyword">if</span> active
      self.trigger <span class="string">"move"</span>, localPosition(e)</code></pre>
</div>
</li>
<li id="section-8">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-8">&#182;</a>
    </div>
    <p>Handle touch moves.</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">  listen element, <span class="string">"touchmove"</span>, (e) -&gt;
    <span class="comment"># Global `event`</span>
    processTouches event, (touch) -&gt;
      self.trigger <span class="string">"move"</span>, localPosition(touch)</code></pre>
</div>
</li>
<li id="section-9">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-9">&#182;</a>
    </div>
    <p>Handle releases.</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">  listen element, <span class="string">"mouseup"</span>, (e) -&gt;
    self.trigger <span class="string">"release"</span>, localPosition(e)
    active = <span class="literal">false</span>

    <span class="keyword">return</span></code></pre>
</div>
</li>
<li id="section-10">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-10">&#182;</a>
    </div>
    <p>Handle touch ends.</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">  listen element, <span class="string">"touchend"</span>, (e) -&gt;
    <span class="comment"># Global `event`</span>
    processTouches event, (touch) -&gt;
      self.trigger <span class="string">"release"</span>, localPosition(touch)</code></pre>
</div>
</li>
<li id="section-11">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-11">&#182;</a>
    </div>
    <p>Whenever the mouse button is released from anywhere, deactivate. Be sure to
trigger the release event if the mousedown started within the element.</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">  listen document, <span class="string">"mouseup"</span>, (e) -&gt;
    <span class="keyword">if</span> active
      self.trigger <span class="string">"release"</span>, localPosition(e)

    active = <span class="literal">false</span>

    <span class="keyword">return</span></code></pre>
</div>
</li>
<li id="section-12">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-12">&#182;</a>
    </div>
    <h2 id="helpers">Helpers</h2>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
</li>
<li id="section-13">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-13">&#182;</a>
    </div>
    <p>Process touches</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">  <span class="function"><span class="title">processTouches</span></span> = (event, fn) -&gt;
    event.preventDefault()

    <span class="keyword">if</span> event.type <span class="keyword">is</span> <span class="string">"touchend"</span>
      <span class="comment"># touchend doesn't have any touches, but does have changed touches</span>
      touches = event.changedTouches
    <span class="keyword">else</span>
      touches = event.touches

    self.debug? Array::map.call touches, ({identifier, pageX, pageY}) -&gt;
      <span class="string">"[<span class="subst">#{identifier}</span>: <span class="subst">#{pageX}</span>, <span class="subst">#{pageY}</span> (<span class="subst">#{event.type}</span>)]\n"</span>

    Array::forEach.call touches, fn</code></pre>
</div>
</li>
<li id="section-14">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-14">&#182;</a>
    </div>
    <p>Local event position.</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">  <span class="function"><span class="title">localPosition</span></span> = (e) -&gt;
    rect = element.getBoundingClientRect()

    point =
      x: (e.pageX - rect.left) / rect.width
      y: (e.pageY - rect.top) / rect.height

    <span class="comment"># Add mouse into touch identifiers as 0</span>
    point.identifier = (e.identifier + <span class="number">1</span>) <span class="keyword">or</span> <span class="number">0</span>

    <span class="keyword">return</span> point</code></pre>
</div>
</li>
<li id="section-15">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-15">&#182;</a>
    </div>
    <p>Return self</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript">  <span class="keyword">return</span> self</code></pre>
</div>
</li>
<li id="section-16">
  <div class="annotation">
    <div class="pilwrap">
      <a class="pilcrow" href="#section-16">&#182;</a>
    </div>
    <p>Attach an event listener to an element</p>

  </div>
  <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">listen</span></span> = (element, event, handler) -&gt;
  element.addEventListener(event, handler, <span class="literal">false</span>)</code></pre>
</div>
</li>
    </ul>
  </div>
  <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/coffee-script/1.6.3/coffee-script.min.js"></script><script>
  (function() {
  var ErrorReporter, bindUpdates, createEditor, exec, findInteractiveElements, readShebang, runners;

  createEditor = function(code, shebang, section) {
    var annotationElement, contentElement, editorElement, exampleSection, runtimeElement;
    exampleSection = $("<li>", {
      "class": "example"
    });
    annotationElement = $("<div>", {
      "class": "annotation"
    });
    editorElement = $("<textarea>", {
      "class": "annotation",
      text: code
    });
    contentElement = $("<div>", {
      "class": "content"
    });
    runtimeElement = $("<div>", {
      "class": "output"
    });
    contentElement.append(runtimeElement);
    annotationElement.append(editorElement);
    exampleSection.append(annotationElement);
    exampleSection.append(contentElement);
    section.after(exampleSection);
    return bindUpdates(shebang, editorElement, runtimeElement);
  };

  bindUpdates = function(shebang, editorElement, runtimeElement) {
    return editorElement.on("keyup", function() {
      var e, report, source;
      report = ErrorReporter(editorElement);
      source = editorElement.val();
      try {
        runners[shebang]({
          editorElement: editorElement,
          source: source,
          runtimeElement: runtimeElement
        });
        return report.clear();
      } catch (_error) {
        e = _error;
        return report(e);
      }
    });
  };

  readShebang = function(source) {
    var match;
    if (match = source.match(/^\#\! (.*)\n/)) {
      return match[1];
    }
  };

  ErrorReporter = function(editor) {
    var reporter;
    reporter = function(error) {
      var errorParagraph;
      if (editor.next().is("p.error")) {
        return editor.next().text(error);
      } else {
        errorParagraph = $("<p>", {
          "class": "error",
          text: error.toString()
        });
        return editor.after(errorParagraph);
      }
    };
    reporter.clear = function() {
      if (editor.next().is("p.error")) {
        return editor.next().remove();
      }
    };
    return reporter;
  };

  findInteractiveElements = function() {
    return $("blockquote > pre > code").each(function() {
      var blockQuoteElement, code, codeElement, sectionElement, shebang;
      codeElement = $(this);
      code = codeElement.text();
      if (shebang = readShebang(code)) {
        if (!runners[shebang]) {
          return;
        }
        code = code.split("\n").slice(1).join("\n");
        blockQuoteElement = codeElement.parent().parent();
        sectionElement = blockQuoteElement.parent().parent();
        blockQuoteElement.remove();
        return createEditor(code, shebang, sectionElement);
      }
    });
  };

  runners = {};

  (typeof window !== "undefined" && window !== null ? window : global).Interactive = {
    register: function(name, runner) {
      runners[name] = runner;
      findInteractiveElements();
      return $('#container').on('keyup', 'textarea', function() {
        $(this).height(0);
        return $(this).height(this.scrollHeight);
      }).find('textarea').keyup();
    }
  };

  exec = function(_arg) {
    var code, editorElement, runtimeElement, source;
    source = _arg.source, code = _arg.code, editorElement = _arg.editorElement, runtimeElement = _arg.runtimeElement;
    runtimeElement.remove();
    editorElement.replaceWith($("<pre>", {
      text: source
    }));
    return setTimeout(function() {
      return Function(code)();
    }, 0);
  };

  $(function() {
    Interactive.register("setup", function(params) {
      params.code = CoffeeScript.compile(params.source);
      return exec(params);
    });
    return Interactive.register("setup-js", function(params) {
      params.code = params.source;
      return exec(params);
    });
  });

}).call(this);

</script><script src="../package.js"></script>
</body>
</html>